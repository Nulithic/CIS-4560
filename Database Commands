wget -O ChicagoCrimes.csv https://data.cityofchicago.org/api/views/ijzp-q8t2/rows.csv

hdfs dfs -mkdir ChicagoCrimes
hdfs dfs -put ChicagoCrimes.csv ChicagoCrimes/
hdfs dfs -chmod -R o+w .

use [username];

CREATE EXTERNAL TABLE IF NOT EXISTS ChicagoCrimes(
id BIGINT,
case_number STRING,
`date` STRING, 
block STRING,
iucr STRING,
primary_type STRING,
description STRING,
location_description STRING,
arrest STRING,
domestic STRING,
beat STRING,
district STRING,
ward STRING,
community_area INT,
fbi_code STRING,
x_coordinate BIGINT,
y_coordinate BIGINT,
year INT,
updated_on STRING,
latitude FLOAT,
longitude FLOAT)
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE LOCATION '/user/tlieu/ChicagoCrimes'
TBLPROPERTIES ('skip.header.line.count'='1');

//Query to find count of each crime.
SELECT primary_type, COUNT(*)
FROM chicagocrimes
GROUP BY primary_type;

//Query for each type of theft
SELECT description, COUNT(*) AS `count`
FROM chicagocrimes
GROUP BY description
ORDER BY `count`;

//A temporary table to change `date` format and data type.
CREATE TABLE cc AS SELECT 
id,
case_number,
FROM_UNIXTIME(UNIX_TIMESTAMP(`date`, 'dd/mm/yyyy h:mm:ss a')) AS `date`, 
block,
iucr,
primary_type,
description,
location_description,
arrest,
domestic,
beat,
district,
ward,
community_area,
fbi_code,
x_coordinate,
y_coordinate,
year,
updated_on,
latitude,
longitude
FROM chicagocrimes;

//Changing `date` from STRING to TIMESTAMP.
ALTER TABLE cc CHANGE COLUMN `date` `date` TIMESTAMP;

//Query to find the count of thefts in each hour.
SELECT count(primary_type) AS theft, date_format(`date`, "hh:00 aa") AS time
FROM cc 
WHERE primary_type ='THEFT' 
GROUP BY date_format(`date`, "hh:00 aa")
ORDER BY theft;

//Created another temporary table for thefts commited between 9:00 AM and 9:00 PM.
CREATE TABLE tt AS SELECT 
id,
case_number,
`date`, 
block,
iucr,
primary_type as crime,
description,
location_description,
arrest,
domestic,
beat,
district,
ward,
community_area,
fbi_code,
x_coordinate,
y_coordinate,
year,
updated_on,
latitude,
longitude
FROM cc 
WHERE date_format(`date`, "HH:mm") BETWEEN '09:00' and '21:00'
AND primary_type ='THEFT';

//Output table for timelapse and heatmap of thefts between 9:00 AM and 9:00 PM.
CREATE TABLE thefts 
ROW FORMAT DELIMITED FIELDS TERMINATED BY ','
STORED AS TEXTFILE LOCATION '/user/tlieu/ChicagoCrimes'
AS SELECT 
id,
case_number,
date_format(`date`, "hh:mm aa") as time, 
block,
iucr,
crime,
description,
location_description,
arrest,
domestic,
beat,
district,
ward,
community_area,
fbi_code,
x_coordinate,
y_coordinate,
year,
updated_on,
latitude,
longitude
FROM tt;

hdfs dfs -get /user/[username]/ChicagoCrimes/0000*_0
ls -al
cat 0000*_0 > thefts.csv

scp [username]@[ip_address]:/home/[username]/thefts.csv thefts.csv
